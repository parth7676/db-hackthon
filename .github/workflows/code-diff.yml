name: Code Diff Analysis

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:
    inputs:
      context_lines:
        description: 'Number of context lines for diff (default: 10)'
        required: false
        default: '10'
        type: string

# Add permissions for commenting on issues/PRs
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  secure-guard-on-duty :
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history to handle initial commits
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Generate diff and AI review using Python script
      id: diff_analysis
      env:
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      run: |
        # Make script executable
        chmod +x scripts/generate_diff.py
        
        # Run the Python script (now includes Databricks API call)
        python scripts/generate_diff.py \
          --context-lines ${{ github.event.inputs.context_lines || 10 }} \
          --output-dir diff_output
        
        # Read the JSON report for outputs
        if [ -f "diff_output/diff_report.json" ]; then
          # Extract values from JSON for GitHub Actions outputs
          PREV_COMMIT=$(python -c "import json; data=json.load(open('diff_output/diff_report.json')); print(data['commits']['previous']['hash'])")
          CURRENT_COMMIT=$(python -c "import json; data=json.load(open('diff_output/diff_report.json')); print(data['commits']['current']['hash'])")
          DIFF_LINES=$(python -c "import json; data=json.load(open('diff_output/diff_report.json')); print(data['statistics']['total_diff_lines'])")
          CHANGED_FILES=$(python -c "import json; data=json.load(open('diff_output/diff_report.json')); print(data['statistics']['changed_files'])")
          IS_INITIAL=$(python -c "import json; data=json.load(open('diff_output/diff_report.json')); print(data['metadata']['is_initial_commit'])")
          
          # Check if AI review was generated
          HAS_AI_REVIEW=$(python -c "import json; data=json.load(open('diff_output/diff_report.json')); print('ai_review' in data)" 2>/dev/null || echo "False")
          
          echo "prev_commit=$PREV_COMMIT" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "diff_lines=$DIFF_LINES" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "is_initial_commit=$IS_INITIAL" >> $GITHUB_OUTPUT
          echo "has_ai_review=$HAS_AI_REVIEW" >> $GITHUB_OUTPUT
        else
          echo "❌ Failed to generate diff report"
          exit 1
        fi
    
    - name: Upload diff artifacts
      uses: actions/upload-artifact@v4
      with:
        name: code-diff-${{ github.run_number }}
        path: |
          diff_output/
        retention-days: 30
    
    - name: Comment on PR with AI Review (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const diffSummary = fs.readFileSync('diff_output/diff_summary.md', 'utf8');
          
          let reviewComment = `## 🔍 Code Diff Analysis\n\n${diffSummary}\n\n*Generated by Python Diff Generator*`;
          
          // Add AI review information if available
          if (fs.existsSync('diff_output/pr_comment.md')) {
            const aiReview = fs.readFileSync('diff_output/pr_comment.md', 'utf8');
            reviewComment += `\n\n${aiReview}`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: reviewComment
          });
    
    - name: Create workflow summary
      run: |
        # Create a summary for the GitHub Actions run
        cat > workflow_summary.md << EOF
        # Code Diff Analysis Summary
        
        ## Run Information
        - **Workflow Run:** #${{ github.run_number }}
        - **Repository:** ${{ github.repository }}
        - **Branch:** ${{ github.ref_name }}
        - **Event:** ${{ github.event_name }}
        - **Context Lines:** ±${{ github.event.inputs.context_lines || 10 }}
        
        ## Commit Information
        - **Previous Commit:** \`${{ steps.diff_analysis.outputs.prev_commit }}\`
        - **Current Commit:** \`${{ steps.diff_analysis.outputs.current_commit }}\`
        - **Total Diff Lines:** ${{ steps.diff_analysis.outputs.diff_lines }}
        - **Changed Files:** ${{ steps.diff_analysis.outputs.changed_files }}
        - **Initial Commit:** ${{ steps.diff_analysis.outputs.is_initial_commit }}
        
        ## AI Code Review
        - **AI Review Generated:** ${{ steps.diff_analysis.outputs.has_ai_review }}
        - **Review Source:** Databricks SecureGuard AI
        
        ## Artifacts
        - **Raw Diff:** \`code_diff.txt\`
        - **Markdown Summary:** \`diff_summary.md\`
        - **JSON Report:** \`diff_report.json\`
        - **AI Review:** \`ai_review.json\`
        - **PR Comment:** \`pr_comment.md\`
        
        [View detailed diff summary](diff_output/diff_summary.md)
        [View AI review](diff_output/ai_review.json)
        EOF
        
        # Add to GitHub Actions summary
        echo "## 📊 Diff Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous Commit:** \`${{ steps.diff_analysis.outputs.prev_commit }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Current Commit:** \`${{ steps.diff_analysis.outputs.current_commit }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Context Lines:** ±${{ github.event.inputs.context_lines || 10 }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Diff Lines:** ${{ steps.diff_analysis.outputs.diff_lines }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Changed Files:** ${{ steps.diff_analysis.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.diff_analysis.outputs.is_initial_commit }}" = "True" ]; then
          echo "- **Note:** This appears to be the initial commit" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## �� AI Code Review" >> $GITHUB_STEP_SUMMARY
        echo "- **AI Review Generated:** ${{ steps.diff_analysis.outputs.has_ai_review }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Review Source:** Databricks SecureGuard AI" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "�� **Artifacts:** All diff files and AI reviews have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
    
    - name: Output final summary
      run: |
        echo "🎉 Code Diff Analysis Complete!"
        echo ""
        echo "📊 Summary:"
        echo "  Previous commit: ${{ steps.diff_analysis.outputs.prev_commit }}"
        echo "  Current commit: ${{ steps.diff_analysis.outputs.current_commit }}"
        echo "  Context lines: ±${{ github.event.inputs.context_lines || 10 }}"
        echo "  Total diff lines: ${{ steps.diff_analysis.outputs.diff_lines }}"
        echo "  Changed files: ${{ steps.diff_analysis.outputs.changed_files }}"
        
        if [ "${{ steps.diff_analysis.outputs.is_initial_commit }}" = "True" ]; then
          echo "  Note: This appears to be the initial commit"
        fi
        
        echo ""
        echo "🤖 AI Code Review:"
        echo "  AI review generated: ${{ steps.diff_analysis.outputs.has_ai_review }}"
        echo "  Review source: Databricks SecureGuard AI"
        
        echo ""
        echo "📁 Artifacts:"
        echo "  - code-diff-${{ github.run_number }}.zip"
        echo "    ├── code_diff.txt (raw diff)"
        echo "    ├── diff_summary.md (formatted summary)"
        echo "    ├── diff_report.json (structured data)"
        echo "    ├── ai_review.json (AI review response)"
        echo "    └── pr_comment.md (PR comment template)"
        echo ""
        echo "🔗 View artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"